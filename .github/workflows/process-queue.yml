name: Process Reading Queue

on:
  push:
    paths:
      - 'queue.md'
    branches:
      - main

jobs:
  process-queue:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for pending URLs
        id: check
        run: |
          # Extract lines between ## Pending and ## Processed that look like URLs
          PENDING=$(sed -n '/^## Pending$/,/^## Processed$/p' queue.md | grep -E '^- https?://' || true)
          if [ -z "$PENDING" ]; then
            echo "has_pending=false" >> "$GITHUB_OUTPUT"
            echo "No pending URLs found"
          else
            echo "has_pending=true" >> "$GITHUB_OUTPUT"
            echo "Found pending URLs:"
            echo "$PENDING"
          fi

      - name: Setup Node.js
        if: steps.check.outputs.has_pending == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        if: steps.check.outputs.has_pending == 'true'
        run: npm install -g @anthropic-ai/claude-code

      - name: Configure git
        if: steps.check.outputs.has_pending == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Process queue with Claude Code
        if: steps.check.outputs.has_pending == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude -p "Read queue.md and find all URLs under the '## Pending' section.

          For each pending URL:
          1. Fetch and read the article using WebFetch
          2. Follow the instructions in CLAUDE.md to add it to the reading list (CHI26/index.html)
          3. After successfully adding it, move the URL from '## Pending' to '## Processed' in queue.md, prefixed with the paper number (e.g., '- #27 https://example.com')

          Process URLs one at a time, committing after each one.
          Commit message format: 'Add paper #{N}: {Short Title}'

          If a URL cannot be fetched, leave it in Pending and add a note: '- https://... (fetch failed â€” retry later)'

          After committing, push changes with: git push origin main" \
            --allowedTools "Read,Write,Edit,WebFetch,WebSearch,Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(git status),Bash(git diff:*),Bash(git log:*)" \
            --max-turns 30 \
            --dangerously-skip-permissions
        timeout-minutes: 30
