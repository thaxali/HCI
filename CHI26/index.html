<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CHI'26 Reading List ‚Äî Seena Labs</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400;1,9..40,500&family=Lora:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@0.469.0/dist/umd/lucide.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>

  :root {
    /* ‚îÄ‚îÄ Color System ‚îÄ‚îÄ */
    --bg: #FAFAF8;
    --bg-elevated: #FFFFFF;
    --bg-sunken: #F2F1EF;
    --bg-hover: #F7F6F4;
    --text-primary: #1A1918;
    --text-secondary: #6B6966;
    --text-tertiary: #9B9691;
    --text-inverse: #FAFAF8;
    --border: #E8E6E3;
    --border-subtle: #F0EEEC;

    /* Accent */
    --accent: #FF5021;
    --accent-hover: #E8481D;
    --accent-subtle: #FF502112;
    --accent-muted: #FF502108;

    /* Semantic */
    --teal: #2C5F6F;
    --teal-subtle: #2C5F6F12;
    --green: #22A06B;
    --green-subtle: #22A06B14;
    --amber: #E8920D;
    --amber-subtle: #E8920D14;
    --blue: #388BFD;
    --blue-subtle: #388BFD14;
    --purple: #8B5CF6;
    --purple-subtle: #8B5CF614;
    --rose: #E11D48;
    --rose-subtle: #E11D4814;

    /* Tag colors */
    --tag-seena-bg: #FF502116;
    --tag-seena-text: #D94318;
    --tag-brainspace-bg: #6B696614;
    --tag-brainspace-text: #FFFFFF;
    --tag-brainspace-fill: #8A8784;
    --tag-eid-bg: #FFE01B;
    --tag-eid-text: #1A1918;
    --tag-valuesensitive-bg: #E8E6E3;
    --tag-valuesensitive-text: #5A5754;

    /* Spacing */
    --space-xs: 4px;
    --space-sm: 8px;
    --space-md: 12px;
    --space-lg: 16px;
    --space-xl: 24px;
    --space-2xl: 32px;
    --space-3xl: 48px;
    --space-4xl: 64px;

    /* Radius */
    --radius-sm: 8px;
    --radius-md: 12px;
    --radius-lg: 16px;
    --radius-xl: 20px;
    --radius-full: 9999px;

    /* Shadows */
    --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.08);
    --shadow-float: 0 12px 40px rgba(0,0,0,0.1);

    /* Typography */
    --font-sans: 'DM Sans', system-ui, -apple-system, sans-serif;
    --font-mono: 'IBM Plex Mono', 'SF Mono', Consolas, monospace;
    --font-serif: 'Lora', Georgia, serif;

    /* Transitions */
    --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
    --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
    --duration-fast: 150ms;
    --duration-normal: 250ms;
    --duration-slow: 400ms;

    /* Layout */
    --max-width: 720px;
    --notes-bar-height: 64px;
  }

  /* ‚îÄ‚îÄ Dark Mode ‚îÄ‚îÄ */
  [data-theme="dark"] {
    --bg: #141413;
    --bg-elevated: #1E1E1C;
    --bg-sunken: #0F0F0E;
    --bg-hover: #252523;
    --text-primary: #EDEDEC;
    --text-secondary: #9B9691;
    --text-tertiary: #6B6966;
    --text-inverse: #1A1918;
    --border: #2A2928;
    --border-subtle: #222221;
    --accent-subtle: #FF502120;
    --accent-muted: #FF502110;
    --teal-subtle: #2C5F6F20;
    --green-subtle: #22A06B20;
    --amber-subtle: #E8920D20;
    --blue-subtle: #388BFD20;
    --purple-subtle: #8B5CF620;
    --rose-subtle: #E11D4820;
    --tag-seena-bg: #FF502120;
    --tag-brainspace-bg: #6B696620;
    --tag-brainspace-fill: #6B6966;
    --tag-eid-bg: #FFE01B30;
    --tag-eid-text: #FFE01B;
    --tag-valuesensitive-bg: #2A2928;
    --tag-valuesensitive-text: #9B9691;
    --shadow-xs: 0 1px 2px rgba(0,0,0,0.2);
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.25);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.35);
  }

  /* ‚îÄ‚îÄ Reset ‚îÄ‚îÄ */
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text-primary);
    font-family: var(--font-sans);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    transition: background var(--duration-normal) var(--ease-out),
                color var(--duration-normal) var(--ease-out);
  }

  /* ‚îÄ‚îÄ App Shell ‚îÄ‚îÄ */
  .app {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: var(--space-4xl) var(--space-xl) 140px;
    min-height: 100vh;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .header {
    margin-bottom: var(--space-3xl);
  }

  .header-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-2xl);
  }

  .seena-mark {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .seena-dot {
    width: 8px;
    height: 8px;
    border-radius: var(--radius-full);
    background: var(--accent);
  }

  .seena-wordmark {
    font-family: var(--font-sans);
    font-weight: 700;
    font-size: 12px;
    color: var(--text-primary);
    letter-spacing: 1.5px;
    text-transform: uppercase;
  }

  .theme-toggle {
    width: 36px;
    height: 36px;
    border-radius: var(--radius-full);
    border: 1px solid var(--border);
    background: var(--bg-elevated);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all var(--duration-fast) var(--ease-out);
    flex-shrink: 0;
    line-height: 1;
  }

  .theme-toggle:hover {
    border-color: var(--text-tertiary);
    background: var(--bg-hover);
  }

  /* Sync Button */
  .sync-btn { position: relative; }
  .sync-btn.syncing i { animation: spin 0.8s linear infinite; }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .sync-btn.synced { color: var(--green) !important; opacity: 1 !important; }
  .sync-btn.sync-error { color: var(--rose) !important; opacity: 1 !important; }

  .eyebrow {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 2.5px;
    text-transform: uppercase;
    color: var(--text-tertiary);
    margin-bottom: var(--space-md);
  }

  h1 {
    font-family: var(--font-sans);
    font-size: 28px;
    font-weight: 600;
    line-height: 1.2;
    color: var(--text-primary);
    letter-spacing: -0.5px;
    margin-bottom: var(--space-md);
  }

  .subtitle {
    font-size: 14px;
    line-height: 1.65;
    color: var(--text-secondary);
    max-width: 560px;
  }

  /* ‚îÄ‚îÄ Stats Row ‚îÄ‚îÄ */
  .stats-row {
    display: flex;
    align-items: center;
    gap: var(--space-lg);
    margin-top: var(--space-xl);
    padding: var(--space-lg) var(--space-xl);
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
  }

  .stat { text-align: center; }

  .stat-value {
    font-family: var(--font-mono);
    font-size: 22px;
    font-weight: 600;
    color: var(--text-primary);
    display: block;
    line-height: 1.2;
  }

  .stat-label {
    font-family: var(--font-mono);
    font-size: 9px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-tertiary);
  }

  .stat-divider {
    width: 1px;
    height: 28px;
    background: var(--border);
  }

  .progress-track {
    flex: 1;
    height: 3px;
    background: var(--bg-sunken);
    border-radius: var(--radius-full);
    overflow: hidden;
    margin-left: var(--space-sm);
  }

  .progress-fill {
    height: 100%;
    background: var(--accent);
    border-radius: var(--radius-full);
    transition: width var(--duration-slow) var(--ease-out);
  }

  /* ‚îÄ‚îÄ Streak ‚îÄ‚îÄ */
  .streak-section {
    margin-top: var(--space-lg);
    padding: var(--space-lg) var(--space-xl);
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
  }

  .streak-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-md);
  }

  .streak-label {
    font-family: var(--font-mono);
    font-size: 10px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--text-tertiary);
  }

  .streak-count {
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 600;
    color: var(--accent);
  }

  .streak-grid {
    display: flex;
    gap: 3px;
    flex-wrap: wrap;
  }

  .streak-dot {
    width: 10px;
    height: 10px;
    border-radius: 2px;
    background: var(--bg-sunken);
    transition: background var(--duration-fast) var(--ease-out);
  }

  .streak-dot.active {
    background: var(--accent);
  }

  .streak-dot.today {
    outline: 1.5px solid var(--accent);
    outline-offset: 1px;
  }

  /* ‚îÄ‚îÄ Search ‚îÄ‚îÄ */
  .search-section {
    margin-bottom: var(--space-xl);
    position: relative;
  }

  .search-input {
    width: 100%;
    font-family: var(--font-sans);
    font-size: 14px;
    padding: var(--space-md) var(--space-lg);
    padding-left: 40px;
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    background: var(--bg-elevated);
    color: var(--text-primary);
    outline: none;
    transition: all var(--duration-fast) var(--ease-out);
  }

  .search-input::placeholder { color: var(--text-tertiary); }
  .search-input:focus { border-color: var(--teal); box-shadow: 0 0 0 3px var(--teal-subtle); }

  .search-icon {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-tertiary);
    font-size: 14px;
    pointer-events: none;
  }

  .search-clear {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-tertiary);
    cursor: pointer;
    font-size: 16px;
    display: none;
    padding: 4px;
  }

  .search-clear.visible { display: block; }

  /* ‚îÄ‚îÄ Filters ‚îÄ‚îÄ */
  .filters {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-xl);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    padding-bottom: 2px;
  }

  .filters::-webkit-scrollbar { display: none; }

  .filter-btn {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.5px;
    padding: 7px 14px;
    border: 1px solid var(--border);
    border-radius: var(--radius-full);
    background: var(--bg-elevated);
    color: var(--text-secondary);
    cursor: pointer;
    white-space: nowrap;
    transition: all var(--duration-fast) var(--ease-out);
  }

  .filter-btn:hover {
    border-color: var(--text-tertiary);
    color: var(--text-primary);
  }

  .filter-btn.active {
    background: var(--text-primary);
    color: var(--text-inverse);
    border-color: var(--text-primary);
  }

  /* ‚îÄ‚îÄ Controls Row ‚îÄ‚îÄ */
  .controls-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-lg);
  }

  .results-count {
    font-family: var(--font-mono);
    font-size: 10px;
    letter-spacing: 1px;
    color: var(--text-tertiary);
    text-transform: uppercase;
  }

  .controls-actions {
    display: flex;
    gap: var(--space-sm);
  }

  .control-btn {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 500;
    padding: 6px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-full);
    background: var(--bg-elevated);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-out);
  }

  .control-btn:hover { border-color: var(--text-tertiary); color: var(--text-primary); }

  /* ‚îÄ‚îÄ Paper Cards ‚îÄ‚îÄ */
  .paper-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .paper {
    background: var(--bg-elevated);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    transition: all var(--duration-normal) var(--ease-out);
    animation: fadeUp 0.3s var(--ease-out) both;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .paper:hover {
    border-color: var(--border);
    box-shadow: var(--shadow-sm);
  }

  .paper.is-read {
    opacity: 0.6;
  }

  .paper.is-read:hover {
    opacity: 0.85;
  }

  .paper.collapsed .paper-body { display: none; }
  .paper.collapsed .paper-top { margin-bottom: 0; cursor: pointer; }
  .paper.collapsed:hover { border-color: var(--accent); }

  .paper-top {
    display: flex;
    align-items: flex-start;
    gap: var(--space-lg);
    margin-bottom: var(--space-lg);
  }

  .paper-number {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 600;
    color: var(--text-tertiary);
    min-width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    flex-shrink: 0;
    margin-top: 2px;
  }

  .paper-content { flex: 1; min-width: 0; }

  .paper-title {
    font-family: var(--font-sans);
    font-size: 15px;
    font-weight: 600;
    line-height: 1.4;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
  }

  .essential-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    font-family: var(--font-mono);
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--accent);
    background: var(--accent-subtle);
    padding: 2px 8px;
    border-radius: var(--radius-full);
    margin-left: var(--space-sm);
    vertical-align: middle;
  }

  .essential-badge::before { content: '‚òÖ'; font-size: 8px; }

  .paper-relevance {
    font-size: 13px;
    line-height: 1.55;
    color: var(--text-secondary);
    margin-bottom: var(--space-md);
  }

  .paper-relevance em {
    font-style: normal;
    color: var(--teal);
    font-weight: 500;
  }

  .paper-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
    margin-bottom: var(--space-sm);
  }

  .paper-tag {
    font-family: var(--font-mono);
    font-size: 9px;
    font-weight: 500;
    letter-spacing: 0.5px;
    padding: 3px 8px;
    border-radius: var(--radius-full);
    text-transform: uppercase;
  }

  .tag-interviews { background: var(--blue-subtle); color: var(--blue); }
  .tag-qual { background: var(--purple-subtle); color: var(--purple); }
  .tag-behavior { background: var(--green-subtle); color: var(--green); }
  .tag-agents { background: var(--teal-subtle); color: var(--teal); }
  .tag-bias { background: var(--rose-subtle); color: var(--rose); }
  .tag-seena { background: var(--tag-seena-bg); color: var(--tag-seena-text); }
  .tag-brainspace { background: var(--tag-brainspace-fill); color: var(--tag-brainspace-text); }
  .tag-eid { background: var(--tag-eid-bg); color: var(--tag-eid-text); font-weight: 600; }
  .tag-valuesensitive { background: var(--tag-valuesensitive-bg); color: var(--tag-valuesensitive-text); }

  .paper-note {
    font-size: 12px;
    font-style: italic;
    color: var(--amber);
    background: var(--amber-subtle);
    padding: var(--space-sm) var(--space-md);
    border-radius: var(--radius-sm);
    margin-top: var(--space-sm);
    line-height: 1.5;
  }

  .paper-actions {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    flex-wrap: wrap;
  }

  .action-btn {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 500;
    letter-spacing: 0.3px;
    padding: 7px 14px;
    border: 1px solid var(--border);
    border-radius: var(--radius-full);
    background: var(--bg-elevated);
    color: var(--text-secondary);
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: all var(--duration-fast) var(--ease-out);
    white-space: nowrap;
  }

  .action-btn:hover {
    border-color: var(--text-tertiary);
    color: var(--text-primary);
  }

  .btn-read.marked {
    background: var(--green-subtle);
    border-color: var(--green);
    color: var(--green);
  }

  .btn-analysis.open {
    background: var(--teal-subtle);
    border-color: var(--teal);
    color: var(--teal);
  }

  /* ‚îÄ‚îÄ Rating ‚îÄ‚îÄ */
  .rating-row {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-top: var(--space-md);
    padding-top: var(--space-md);
    border-top: 1px solid var(--border-subtle);
  }

  .rating-label {
    font-family: var(--font-mono);
    font-size: 9px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--text-tertiary);
    margin-right: var(--space-xs);
  }

  .rating-star {
    font-size: 16px;
    cursor: pointer;
    color: var(--border);
    transition: all var(--duration-fast) var(--ease-out);
    padding: 2px;
    line-height: 1;
  }

  .rating-star:hover, .rating-star.filled {
    color: var(--amber);
  }

  .rating-star.filled {
    transform: scale(1.05);
  }

  /* ‚îÄ‚îÄ Note count badge ‚îÄ‚îÄ */
  .note-count-badge {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--teal);
    border: 1px solid var(--teal);
    background: var(--teal-subtle);
    padding: 5px 10px;
    border-radius: var(--radius-full);
    cursor: default;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  /* ‚îÄ‚îÄ Paper Notes Section ‚îÄ‚îÄ */
  .paper-notes-section {
    margin-top: var(--space-lg);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--border-subtle);
  }

  .paper-notes-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-md);
  }

  .paper-notes-title {
    font-family: var(--font-mono);
    font-size: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--text-tertiary);
  }

  .paper-notes-count {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-tertiary);
  }

  .paper-note-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-sunken);
    border-radius: var(--radius-sm);
    margin-bottom: var(--space-xs);
    font-size: 13px;
    line-height: 1.5;
  }

  .paper-note-type {
    font-size: 12px;
    flex-shrink: 0;
    margin-top: 1px;
  }

  .paper-note-text {
    flex: 1;
    color: var(--text-secondary);
    min-width: 0;
  }

  .paper-note-time {
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--text-tertiary);
    white-space: nowrap;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .paper-note-delete {
    background: none;
    border: none;
    color: var(--text-tertiary);
    cursor: pointer;
    font-size: 14px;
    padding: 0 2px;
    opacity: 0;
    transition: opacity var(--duration-fast);
    flex-shrink: 0;
  }

  .paper-note-item:hover .paper-note-delete { opacity: 1; }

  /* ‚îÄ‚îÄ Analysis Panels (preserved style, refined) ‚îÄ‚îÄ */
  .analysis-panel {
    margin-top: var(--space-lg);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--border-subtle);
  }

  .analysis-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-lg);
  }

  .analysis-badge {
    font-family: var(--font-mono);
    font-size: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--teal);
    background: var(--teal-subtle);
    padding: 4px 10px;
    border-radius: var(--radius-full);
  }

  .analysis-meta {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-tertiary);
  }

  .tts-controls {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md) var(--space-lg);
    background: var(--bg-sunken);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-lg);
  }

  .tts-btn {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 500;
    padding: 6px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-full);
    background: var(--bg-elevated);
    color: var(--text-secondary);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-out);
  }

  .tts-btn:hover { border-color: var(--text-tertiary); color: var(--text-primary); }

  .tts-status {
    font-family: var(--font-mono);
    font-size: 10px;
    color: var(--text-tertiary);
    margin-left: auto;
  }

  .tts-vitals {
    font-size: 13px;
    line-height: 1.7;
    color: var(--text-secondary);
    padding: var(--space-lg);
    background: var(--bg-sunken);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-xl);
  }

  .tts-vitals strong { color: var(--text-primary); font-weight: 600; }

  .tts-section { margin-bottom: var(--space-xl); }

  .tts-section-title {
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    color: var(--teal);
    margin-bottom: var(--space-md);
  }

  .tts-paragraph {
    font-family: var(--font-serif);
    font-size: 15px;
    line-height: 1.85;
    color: var(--text-secondary);
    padding: var(--space-md) var(--space-lg);
    border-radius: var(--radius-md);
    cursor: pointer;
    margin-bottom: var(--space-sm);
    transition: all var(--duration-fast) var(--ease-out);
    border-left: 2px solid transparent;
  }

  .tts-paragraph:hover { background: var(--bg-hover); }
  .tts-paragraph.speaking {
    background: var(--teal-subtle);
    border-left-color: var(--teal);
  }

  .highlight {
    color: var(--text-primary);
    font-weight: 500;
  }

  .stat-highlight {
    font-family: var(--font-mono);
    font-weight: 600;
    color: var(--accent);
  }

  .divider {
    height: 1px;
    background: var(--border-subtle);
    margin: var(--space-xl) 0;
  }

  .empty-state {
    text-align: center;
    padding: var(--space-4xl) var(--space-xl);
    color: var(--text-tertiary);
    font-size: 14px;
  }

  /* ‚îÄ‚îÄ Markdown Analysis Content ‚îÄ‚îÄ */
  .analysis-content h2 {
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.5px;
    color: var(--teal);
    margin-bottom: var(--space-md);
    margin-top: var(--space-xl);
  }

  .analysis-content h2:first-child { margin-top: 0; }

  .analysis-content p {
    font-family: var(--font-serif);
    font-size: 15px;
    line-height: 1.85;
    color: var(--text-secondary);
    padding: var(--space-md) var(--space-lg);
    border-radius: var(--radius-md);
    cursor: pointer;
    margin-bottom: var(--space-sm);
    transition: all var(--duration-fast) var(--ease-out);
    border-left: 2px solid transparent;
  }

  .analysis-content p:hover { background: var(--bg-hover); }
  .analysis-content p.speaking {
    background: var(--teal-subtle);
    border-left-color: var(--teal);
  }

  .analysis-content strong {
    color: var(--text-primary);
    font-weight: 500;
  }

  .analysis-content hr {
    border: none;
    height: 1px;
    background: var(--border-subtle);
    margin: var(--space-xl) 0;
  }

  /* ‚îÄ‚îÄ Notes Bar ‚îÄ‚îÄ */
  .notes-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--bg-elevated);
    border-top: 1px solid var(--border);
    padding: var(--space-md) var(--space-lg);
    z-index: 100;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }

  .notes-bar-inner {
    max-width: var(--max-width);
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .notes-bar-top {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .notes-bar-meta {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .notes-input-container {
    display: flex;
    align-items: flex-end;
    gap: var(--space-sm);
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 4px 4px 4px 0;
    transition: border-color var(--duration-fast) var(--ease-out);
  }

  .notes-input-container:focus-within {
    border-color: var(--teal);
  }

  .notes-input-actions {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-shrink: 0;
    padding-right: 2px;
  }

  .notes-context-badge {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 600;
    color: var(--teal);
    background: var(--teal-subtle);
    padding: 4px 8px;
    border-radius: var(--radius-full);
    cursor: pointer;
    flex-shrink: 0;
    display: inline-flex;
    align-items: center;
    gap: 2px;
    align-self: center;
    transition: all var(--duration-fast) var(--ease-out);
  }

  .notes-context-badge:hover { background: var(--teal); color: white; }

  /* ‚îÄ‚îÄ Note Type Selector ‚îÄ‚îÄ */
  .note-type-selector {
    display: flex;
    gap: 2px;
    align-self: center;
    flex-shrink: 0;
  }

  .note-type-btn {
    width: 30px;
    height: 30px;
    border: 1px solid transparent;
    border-radius: var(--radius-sm);
    background: none;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--duration-fast) var(--ease-out);
    opacity: 0.5;
  }

  .note-type-btn:hover { opacity: 0.8; background: var(--bg-hover); }
  .note-type-btn.active {
    opacity: 1;
    border-color: var(--border);
    background: var(--bg-sunken);
  }

  .notes-input {
    flex: 1;
    font-family: var(--font-sans);
    font-size: 14px;
    padding: 8px 14px;
    border: none;
    border-radius: var(--radius-lg);
    background: transparent;
    color: var(--text-primary);
    outline: none;
    resize: none;
    min-height: 38px;
    max-height: 100px;
    line-height: 1.4;
  }

  .notes-input::placeholder { color: var(--text-tertiary); }

  /* ‚îÄ‚îÄ Voice Note Button ‚îÄ‚îÄ */
  .voice-btn {
    width: 32px;
    height: 32px;
    border: 1px solid var(--border);
    border-radius: var(--radius-full);
    background: var(--bg-elevated);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    flex-shrink: 0;
    transition: all var(--duration-fast) var(--ease-out);
    position: relative;
    color: var(--text-secondary);
  }

  .voice-btn:hover { border-color: var(--text-tertiary); }

  .voice-btn.recording {
    border-color: var(--accent);
    background: var(--accent-subtle);
    animation: voicePulse 1.5s ease-in-out infinite;
  }

  @keyframes voicePulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(255,80,33,0.3); }
    50% { box-shadow: 0 0 0 8px rgba(255,80,33,0); }
  }

  .notes-send-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: var(--radius-full);
    background: var(--text-primary);
    color: var(--text-inverse);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-out);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
  }

  .notes-send-btn:hover { opacity: 0.85; }
  .notes-send-btn:active { transform: scale(0.94); }

  .notes-download-btn {
    width: 28px;
    height: 28px;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: none;
    color: var(--text-tertiary);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease-out);
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    padding: 0;
  }

  .notes-download-btn:hover { border-color: var(--text-tertiary); color: var(--text-primary); }

  .notes-count {
    font-family: var(--font-mono);
    font-size: 9px;
    color: var(--text-tertiary);
    white-space: nowrap;
    align-self: center;
    flex-shrink: 0;
  }

  .notes-toast {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(10px);
    font-family: var(--font-mono);
    font-size: 11px;
    padding: 8px 18px;
    background: var(--text-primary);
    color: var(--text-inverse);
    border-radius: var(--radius-full);
    opacity: 0;
    transition: all 0.3s var(--ease-out);
    pointer-events: none;
    z-index: 101;
  }

  .notes-toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* ‚îÄ‚îÄ @ Mention Autocomplete ‚îÄ‚îÄ */
  .mention-dropdown {
    position: fixed;
    bottom: 76px;
    left: 50%;
    transform: translateX(-50%);
    width: min(400px, 90vw);
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    z-index: 200;
    max-height: 200px;
    overflow-y: auto;
    display: none;
  }

  .mention-dropdown.visible { display: block; }

  .mention-item {
    padding: var(--space-sm) var(--space-md);
    font-size: 13px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    transition: background var(--duration-fast);
  }

  .mention-item:hover, .mention-item.active {
    background: var(--bg-hover);
  }

  .mention-item-id {
    font-family: var(--font-mono);
    font-size: 10px;
    font-weight: 600;
    color: var(--teal);
    min-width: 30px;
  }

  .mention-item-title {
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
  @media (max-width: 640px) {
    .app { padding: var(--space-2xl) var(--space-lg) 140px; }
    h1 { font-size: 22px; }
    .subtitle { font-size: 13px; }
    .stats-row { padding: var(--space-md) var(--space-lg); gap: var(--space-md); flex-wrap: wrap; }
    .stat-value { font-size: 18px; }
    .progress-track { width: 100%; margin-left: 0; }
    .paper { padding: var(--space-lg); }
    .paper-top { gap: var(--space-md); }
    .paper-number { min-width: 24px; height: 24px; font-size: 9px; }
    .paper-title { font-size: 14px; }
    .paper-relevance { font-size: 12px; }
    .paper-actions { gap: var(--space-xs); }
    .action-btn { padding: 6px 10px; font-size: 9px; }
    .filter-btn { padding: 6px 10px; font-size: 9px; }
    .tts-paragraph { font-size: 14px; padding: var(--space-sm) var(--space-md); }
    .tts-controls { flex-wrap: wrap; gap: var(--space-xs); padding: var(--space-sm) var(--space-md); }
    .tts-btn { padding: 5px 10px; font-size: 9px; }
    .notes-bar { padding: var(--space-sm) var(--space-md); }
    .notes-bar-meta { display: none; }
    .notes-input { font-size: 16px; }
    .note-type-selector { gap: 1px; }
    .note-type-btn { width: 26px; height: 26px; font-size: 12px; }
    .notes-input-container { border-radius: var(--radius-md); }
    .streak-section { padding: var(--space-md) var(--space-lg); }
    .streak-dot { width: 8px; height: 8px; }
    .controls-row { flex-wrap: wrap; gap: var(--space-sm); }
    .rating-star { font-size: 20px; padding: 4px; }
    .search-input { font-size: 16px; }
  }

  /* ‚îÄ‚îÄ Settings Modal ‚îÄ‚îÄ */
  .settings-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(4px);
    z-index: 2000;
    align-items: center;
    justify-content: center;
  }
  .settings-overlay.open { display: flex; }
  .settings-modal {
    background: var(--bg-elevated);
    border-radius: var(--radius-lg);
    width: 90%;
    max-width: 440px;
    box-shadow: 0 24px 80px rgba(0,0,0,0.15);
    overflow: hidden;
  }
  .settings-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
  }
  .settings-title {
    font-family: var(--font-mono);
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-primary);
  }
  .settings-close {
    background: none;
    border: none;
    font-size: 20px;
    color: var(--text-tertiary);
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
  }
  .settings-close:hover { background: var(--bg-sunken); }
  .settings-body { padding: 20px; }
  .settings-desc {
    font-size: 13px;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: 16px;
  }
  .settings-label {
    display: block;
    font-family: var(--font-mono);
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-secondary);
    margin-bottom: 6px;
  }
  .settings-input {
    display: block;
    width: 100%;
    padding: 10px 12px;
    font-family: var(--font-mono);
    font-size: 13px;
    background: var(--bg-sunken);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-primary);
    outline: none;
    box-sizing: border-box;
  }
  .settings-input:focus { border-color: var(--accent); }
  .settings-input code, .settings-hint code {
    font-family: var(--font-mono);
    background: var(--bg-sunken);
    padding: 1px 5px;
    border-radius: 4px;
    font-size: 12px;
  }
  .settings-hint {
    font-size: 12px;
    color: var(--text-tertiary);
    margin-top: 6px;
    line-height: 1.4;
  }
  .settings-hint a { color: var(--accent); text-decoration: none; }
  .settings-hint a:hover { text-decoration: underline; }
  .settings-actions {
    display: flex;
    gap: 8px;
    margin-top: 16px;
  }
  .settings-btn {
    padding: 8px 16px;
    font-family: var(--font-mono);
    font-size: 12px;
    font-weight: 500;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    background: var(--bg-sunken);
    color: var(--text-primary);
    transition: all 0.15s;
  }
  .settings-btn:hover { background: var(--bg-hover); }
  .settings-btn-save {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }
  .settings-btn-save:hover { background: var(--accent-hover); }
  .settings-status {
    font-size: 12px;
    margin-top: 10px;
    color: var(--text-secondary);
    font-family: var(--font-mono);
  }
  .gh-connected { opacity: 1 !important; color: var(--green) !important; }

  /* ‚îÄ‚îÄ Lucide Icon Helpers ‚îÄ‚îÄ */
  [data-lucide] {
    width: 1em;
    height: 1em;
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
    line-height: 1;
  }
  .expand-chevron {
    color: var(--text-tertiary);
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    align-self: center;
  }

</style>
</head>
<body>

<div class="app">
  <header class="header">
    <div class="header-top">
      <div class="seena-mark">
        <div class="seena-dot"></div>
        <span class="seena-wordmark">Seena</span>
      </div>
      <div style="display:flex;align-items:center;gap:4px;">
        <button class="theme-toggle" onclick="openQueueModal()" title="Add URL to reading queue"><i data-lucide="plus"></i></button>
        <button class="theme-toggle sync-btn" id="syncBtn" onclick="quickSync()" title="Sync with GitHub" style="display:none;"><i data-lucide="refresh-cw" id="syncIcon"></i></button>
        <button class="theme-toggle" id="ghSyncStatus" onclick="openSettings()" title="GitHub sync settings" style="font-size:16px;opacity:0.5;"><i data-lucide="github"></i></button>
        <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle dark mode"><i data-lucide="sun"></i></button>
      </div>
    </div>
    <div class="eyebrow">CHI 2026 ¬∑ Research Reading List</div>
    <h1>Flagged Papers</h1>
    <p class="subtitle">25 papers from the CHI'26 preprint collection mapped across Seena Labs, Brain Space, and Everything is Designed.</p>

    <div class="stats-row">
      <div class="stat">
        <span class="stat-value" id="readCount">0</span>
        <span class="stat-label">read</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat">
        <span class="stat-value" id="totalCount">25</span>
        <span class="stat-label">total</span>
      </div>
      <div class="progress-track">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
    </div>

    <div class="streak-section" id="streakSection">
      <div class="streak-header">
        <span class="streak-label">Reading Activity</span>
        <span class="streak-count" id="streakCount"></span>
      </div>
      <div class="streak-grid" id="streakGrid"></div>
    </div>
  </header>

  <div class="search-section">
    <span class="search-icon"><i data-lucide="search"></i></span>
    <input type="text" class="search-input" id="searchInput" placeholder="Search papers..." autocomplete="off">
    <button class="search-clear" id="searchClear" onclick="clearSearch()">√ó</button>
  </div>

  <div class="filters" id="filtersRow">
    <button class="filter-btn active" data-filter="all">All</button>
    <button class="filter-btn" data-filter="interviews">Interviews</button>
    <button class="filter-btn" data-filter="qual">Qual Analysis</button>
    <button class="filter-btn" data-filter="behavior">Behavior</button>
    <button class="filter-btn" data-filter="agents">Agents</button>
    <button class="filter-btn" data-filter="bias">LLM Bias</button>
    <button class="filter-btn" data-filter="seena">Seena Labs</button>
    <button class="filter-btn" data-filter="brainspace">Brain Space</button>
    <button class="filter-btn" data-filter="eid">Everything is Designed</button>
    <button class="filter-btn" data-filter="valuesensitive">Value-Sensitive</button>
    <button class="filter-btn" data-filter="read">‚úì Read</button>
    <button class="filter-btn" data-filter="unread">Unread</button>
  </div>

  <div class="controls-row">
    <span class="results-count" id="resultsCount"></span>
    <div class="controls-actions">
      <button class="control-btn" id="collapseToggle" onclick="toggleCollapseAll()"><i data-lucide="rows-" style="margin-right:4px;font-size:13px;"></i> Collapse all</button>
    </div>
  </div>

  <div class="paper-list" id="paperList"></div>
</div>

<!-- Settings Modal -->
<div class="settings-overlay" id="settingsOverlay" onclick="if(event.target===this)closeSettings()">
  <div class="settings-modal">
    <div class="settings-header">
      <span class="settings-title">GitHub Sync</span>
      <button class="settings-close" onclick="closeSettings()">√ó</button>
    </div>
    <div class="settings-body">
      <p class="settings-desc">Connect to GitHub so your notes are saved as markdown files in the repo. Claude can then read and write to these files through its GitHub connection.</p>
      <label class="settings-label">Personal Access Token</label>
      <input type="password" class="settings-input" id="ghTokenInput" placeholder="ghp_xxxxxxxxxxxx" autocomplete="off">
      <p class="settings-hint">Create a <a href="https://github.com/settings/tokens?type=beta" target="_blank" rel="noopener">fine-grained token</a> with read/write Contents access scoped to <code>thaxali/HCI</code>.</p>
      <label class="settings-label" style="margin-top:12px;">Repository</label>
      <input type="text" class="settings-input" id="ghRepoInput" value="thaxali/HCI" autocomplete="off">
      <label class="settings-label" style="margin-top:12px;">Notes folder path</label>
      <input type="text" class="settings-input" id="ghPathInput" value="CHI26/notes" autocomplete="off">
      <div class="settings-actions">
        <button class="settings-btn settings-btn-test" onclick="testGitHubConnection()">Test connection</button>
        <button class="settings-btn settings-btn-save" onclick="saveGitHubSettings()">Save</button>
      </div>
      <div class="settings-status" id="ghSettingsStatus"></div>
      <div class="settings-sync-section" id="ghSyncSection" style="display:none;">
        <hr style="border:none;border-top:1px solid var(--border);margin:16px 0;">
        <p class="settings-label">Sync</p>
        <div class="settings-actions">
          <button class="settings-btn settings-btn-test" onclick="syncNotesToGitHub()">Push all notes to GitHub</button>
          <button class="settings-btn settings-btn-test" onclick="pullNotesFromGitHub()">Pull notes from GitHub</button>
        </div>
        <div class="settings-status" id="ghSyncStatus2"></div>
      </div>
    </div>
  </div>
</div>

<!-- Queue Modal -->
<div class="settings-overlay" id="queueOverlay" onclick="if(event.target===this)closeQueueModal()">
  <div class="settings-modal">
    <div class="settings-header">
      <span class="settings-title">Add to Queue</span>
      <button class="settings-close" onclick="closeQueueModal()">√ó</button>
    </div>
    <div class="settings-body">
      <p class="settings-desc">Paste a URL and it will be added to the processing queue. Claude will automatically fetch, analyze, and add it to your reading list.</p>
      <label class="settings-label">Article URL</label>
      <input type="url" class="settings-input" id="queueUrlInput" placeholder="https://arxiv.org/abs/..." autocomplete="off" onkeydown="if(event.key==='Enter')submitToQueue()">
      <p class="settings-hint">Supports arxiv papers, blog posts, newsletters ‚Äî anything with a URL.</p>
      <div class="settings-actions">
        <button class="settings-btn settings-btn-save" id="queueSubmitBtn" onclick="submitToQueue()">Add to queue</button>
      </div>
      <div class="settings-status" id="queueStatus"></div>
    </div>
  </div>
</div>

<!-- Mention Autocomplete -->
<div class="mention-dropdown" id="mentionDropdown"></div>

<!-- Notes Bar -->
<div class="notes-bar">
  <div class="notes-bar-inner">
    <div class="notes-bar-top">
      <span id="notesContextBadge" style="display:none" class="notes-context-badge" onclick="clearPaperContext()"></span>
      <div class="note-type-selector">
        <button class="note-type-btn active" data-type="note" onclick="setNoteType('note')" title="Note"><i data-lucide="pen-line"></i></button>
        <button class="note-type-btn" data-type="idea" onclick="setNoteType('idea')" title="Idea"><i data-lucide="lightbulb"></i></button>
        <button class="note-type-btn" data-type="question" onclick="setNoteType('question')" title="Question"><i data-lucide="circle-help"></i></button>
        <button class="note-type-btn" data-type="connection" onclick="setNoteType('connection')" title="Connection"><i data-lucide="link"></i></button>
        <button class="note-type-btn" data-type="action" onclick="setNoteType('action')" title="Action Item"><i data-lucide="square-check-big"></i></button>
      </div>
      <div class="notes-bar-meta">
        <span class="notes-count" id="notesCount"></span>
        <button class="notes-download-btn" onclick="downloadNotes()" title="Export notes"><i data-lucide="download"></i></button>
      </div>
    </div>
    <div class="notes-input-container">
      <textarea class="notes-input" id="notesInput" placeholder="Jot a note..." rows="1"></textarea>
      <div class="notes-input-actions">
        <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceNote()" title="Voice note"><i data-lucide="mic"></i></button>
        <button class="notes-send-btn" onclick="addNote()" title="Add note"><i data-lucide="arrow-up"></i></button>
      </div>
    </div>
  </div>
</div>
<div class="notes-toast" id="notesToast"></div>

<script>
// ‚îÄ‚îÄ Papers Data (loaded from papers.json) ‚îÄ‚îÄ
let papers = [];
const analysisCache = {};

async function loadPapers() {
  try {
    const res = await fetch('papers.json');
    papers = await res.json();
  } catch (e) {
    console.error('Failed to load papers.json:', e);
    papers = [];
  }
}

async function loadAnalysis(id) {
  if (analysisCache[id]) return analysisCache[id];
  const filename = String(id).padStart(3, '0') + '.md';
  try {
    const res = await fetch('papers/' + filename);
    if (!res.ok) return null;
    const md = await res.text();
    analysisCache[id] = renderAnalysisMarkdown(md);
    return analysisCache[id];
  } catch {
    return null;
  }
}

function renderAnalysisMarkdown(md) {
  const lines = md.split('\n');
  let headerLine = '';
  let vitals = [];
  let bodyStart = 0;

  // Parse header (first line, italic ‚Äî *Badge ¬∑ Listen time*)
  if (lines[0].startsWith('*') && lines[0].endsWith('*')) {
    headerLine = lines[0].slice(1, -1);
    bodyStart = 1;
  }

  // Skip blank lines after header
  while (bodyStart < lines.length && lines[bodyStart].trim() === '') bodyStart++;

  // Parse vitals (lines starting with **Key:** until ---)
  while (bodyStart < lines.length && lines[bodyStart].startsWith('**')) {
    const match = lines[bodyStart].match(/^\*\*(.+?)\*\*\s*(.+)$/);
    if (match) vitals.push({ label: match[1], value: match[2] });
    bodyStart++;
  }

  // Skip blank lines and first --- divider
  while (bodyStart < lines.length && (lines[bodyStart].trim() === '' || lines[bodyStart].trim() === '---')) bodyStart++;

  // Render body with marked.js
  const bodyMd = lines.slice(bodyStart).join('\n');
  const bodyHtml = marked.parse(bodyMd);

  // Build badge/meta from header line
  let badgeText = 'Analysis';
  let metaText = '';
  if (headerLine.includes('¬∑')) {
    const parts = headerLine.split('¬∑').map(s => s.trim());
    metaText = parts.pop();
    badgeText = parts.join(' ¬∑ ');
  }

  // Build vitals HTML
  const vitalsHtml = vitals.map(v =>
    `<strong>${v.label}</strong> ${v.value}`
  ).join('<br>');

  return `
    <div class="analysis-panel open">
      <div class="analysis-header">
        <div class="analysis-badge">${badgeText}</div>
        <div class="analysis-meta">${metaText}</div>
      </div>
      <div class="tts-controls">
        <button class="tts-btn" onclick="ttsPlayAll()">‚ñ∂ Play All</button>
        <button class="tts-btn" onclick="ttsPause()">‚è∏ Pause</button>
        <button class="tts-btn" onclick="ttsStop()">‚èπ Stop</button>
        <span class="tts-status" id="ttsStatus">Click any paragraph to start</span>
      </div>
      ${vitalsHtml ? '<div class="tts-vitals">' + vitalsHtml + '</div>' : ''}
      <div class="analysis-content">${bodyHtml}</div>
    </div>`;
}

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
const NOTES_KEY = 'chi26-reading-notes';
const STREAK_KEY = 'chi26-streak';
const RATINGS_KEY = 'chi26-ratings';
const THEME_KEY = 'chi26-theme';
const COLLAPSED_KEY = 'chi26-collapsed';
let currentFilter = 'all';
let searchQuery = '';
let analysisOpen = {};
let activePaperId = null;
let currentNoteType = 'note';
let allCollapsed = false;
let isRecording = false;
let recognition = null;
let mentionActive = false;
let mentionStart = -1;
let mentionIndex = 0;

const noteTypeMap = {
  note: ['üìù', 'Note'],
  idea: ['üí°', 'Idea'],
  question: ['‚ùì', 'Question'],
  connection: ['üîó', 'Connection'],
  action: ['üìã', 'Action']
};

// ‚îÄ‚îÄ Load State ‚îÄ‚îÄ
function loadReadState() {
  try {
    const saved = JSON.parse(localStorage.getItem('seena-chi26-read') || '[]');
    papers.forEach(p => { if (saved.includes(p.id)) p.read = true; });
  } catch {}
}

function saveState() {
  localStorage.setItem('seena-chi26-read', JSON.stringify(papers.filter(p => p.read).map(p => p.id)));
}

// ‚îÄ‚îÄ Theme ‚îÄ‚îÄ
function loadTheme() {
  const saved = localStorage.getItem(THEME_KEY) || 'light';
  document.documentElement.setAttribute('data-theme', saved);
  updateThemeIcon(saved);
}

function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme');
  const next = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem(THEME_KEY, next);
  updateThemeIcon(next);
}

function updateThemeIcon(theme) {
  document.getElementById('themeToggle').innerHTML = theme === 'dark' ? '<i data-lucide="moon"></i>' : '<i data-lucide="sun"></i>';
  if (window.lucide) lucide.createIcons();
}

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
function updateStats() {
  const readCount = papers.filter(p => p.read).length;
  document.getElementById('readCount').textContent = readCount;
  document.getElementById('totalCount').textContent = papers.length;
  document.getElementById('progressFill').style.width = `${(readCount / papers.length) * 100}%`;
}

// ‚îÄ‚îÄ Streak ‚îÄ‚îÄ
function getStreakData() {
  try { return JSON.parse(localStorage.getItem(STREAK_KEY) || '{}'); } catch { return {}; }
}

function recordActivity() {
  const data = getStreakData();
  const today = new Date().toISOString().split('T')[0];
  data[today] = (data[today] || 0) + 1;
  localStorage.setItem(STREAK_KEY, JSON.stringify(data));
  renderStreak();
}

function renderStreak() {
  const data = getStreakData();
  const grid = document.getElementById('streakGrid');
  const today = new Date();
  const days = 28; // 4 weeks
  let dots = '';
  let streakDays = 0;

  for (let i = days - 1; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    const key = d.toISOString().split('T')[0];
    const active = data[key] ? 'active' : '';
    const isToday = i === 0 ? 'today' : '';
    dots += `<div class="streak-dot ${active} ${isToday}" title="${key}${data[key] ? ' ¬∑ ' + data[key] + ' actions' : ''}"></div>`;
  }

  // Count current streak
  for (let i = 0; i <= days; i++) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    const key = d.toISOString().split('T')[0];
    if (data[key]) streakDays++;
    else if (i > 0) break;
  }

  grid.innerHTML = dots;
  document.getElementById('streakCount').textContent = streakDays > 0 ? `${streakDays} day${streakDays > 1 ? 's' : ''} active` : '';
}

// ‚îÄ‚îÄ Ratings ‚îÄ‚îÄ
function getRatings() {
  try { return JSON.parse(localStorage.getItem(RATINGS_KEY) || '{}'); } catch { return {}; }
}

function setRating(paperId, rating) {
  const ratings = getRatings();
  ratings[paperId] = rating;
  localStorage.setItem(RATINGS_KEY, JSON.stringify(ratings));
  renderPapers();
  recordActivity();
}

function renderRating(paperId) {
  const ratings = getRatings();
  const current = ratings[paperId] || 0;
  let stars = '<div class="rating-row"><span class="rating-label">Rating</span>';
  for (let i = 1; i <= 5; i++) {
    stars += `<span class="rating-star ${i <= current ? 'filled' : ''}" onclick="event.stopPropagation(); setRating(${paperId}, ${i === current ? 0 : i})">‚òÖ</span>`;
  }
  stars += '</div>';
  return stars;
}

// ‚îÄ‚îÄ Search ‚îÄ‚îÄ
document.getElementById('searchInput').addEventListener('input', function() {
  searchQuery = this.value.trim().toLowerCase();
  document.getElementById('searchClear').classList.toggle('visible', searchQuery.length > 0);
  renderPapers();
});

function clearSearch() {
  document.getElementById('searchInput').value = '';
  searchQuery = '';
  document.getElementById('searchClear').classList.remove('visible');
  renderPapers();
}

// ‚îÄ‚îÄ Notes ‚îÄ‚îÄ
function getNotes() {
  try { return JSON.parse(localStorage.getItem(NOTES_KEY) || '[]'); } catch { return []; }
}

function saveNotes(notes) {
  localStorage.setItem(NOTES_KEY, JSON.stringify(notes));
  updateNotesCount();
}

function setNoteType(type) {
  currentNoteType = type;
  document.querySelectorAll('.note-type-btn').forEach(b => b.classList.toggle('active', b.dataset.type === type));
}

function addNote() {
  const input = document.getElementById('notesInput');
  const text = input.value.trim();
  if (!text) return;

  const notes = getNotes();
  const paper = activePaperId ? papers.find(p => p.id === activePaperId) : null;
  notes.push({
    text,
    type: currentNoteType,
    paperId: activePaperId || null,
    paperTitle: paper ? paper.title : null,
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' })
  });
  saveNotes(notes);
  input.value = '';
  input.style.height = 'auto';
  const label = paper ? `${noteTypeMap[currentNoteType][1]} saved to P${String(activePaperId).padStart(2,'0')} ‚úì` : `${noteTypeMap[currentNoteType][1]} saved ‚úì`;
  showToast(label);
  renderPapers();
  recordActivity();
}

function deleteNote(index) {
  const notes = getNotes();
  notes.splice(index, 1);
  saveNotes(notes);
  renderPapers();
  showToast('Note deleted');
}

function setPaperContext(id) {
  activePaperId = id;
  const paper = papers.find(p => p.id === id);
  const badge = document.getElementById('notesContextBadge');
  const input = document.getElementById('notesInput');
  badge.innerHTML = `P${String(id).padStart(2,'0')}<span style="margin-left:4px;font-size:11px;opacity:0.6">√ó</span>`;
  badge.style.display = 'inline-flex';
  input.placeholder = `Note on "${paper.title.substring(0, 35)}..."`;
}

function clearPaperContext() {
  activePaperId = null;
  document.getElementById('notesContextBadge').style.display = 'none';
  document.getElementById('notesInput').placeholder = 'Jot a note...';
}

function renderPaperNotes(paperId) {
  const notes = getNotes().filter(n => n.paperId === paperId);
  if (notes.length === 0) return '';

  const allNotes = getNotes();
  const items = notes.map(n => {
    const idx = allNotes.findIndex(gn => gn.timestamp === n.timestamp && gn.text === n.text);
    const icon = noteTypeMap[n.type || 'note'][0];
    return `<div class="paper-note-item">
      <span class="paper-note-type">${icon}</span>
      <div class="paper-note-text">${n.text}</div>
      <span class="paper-note-time">${n.date}</span>
      <button class="paper-note-delete" onclick="event.stopPropagation(); deleteNote(${idx})" title="Delete">√ó</button>
    </div>`;
  }).join('');

  return `<div class="paper-notes-section">
    <div class="paper-notes-header">
      <span class="paper-notes-title">My Notes</span>
      <span class="paper-notes-count">${notes.length}</span>
    </div>
    ${items}
  </div>`;
}

function updateNotesCount() {
  const allNotes = getNotes();
  const count = allNotes.length;
  const tagged = allNotes.filter(n => n.paperId).length;
  const el = document.getElementById('notesCount');
  if (count === 0) el.textContent = '';
  else if (tagged > 0) el.textContent = `${count} (${tagged} tagged)`;
  else el.textContent = `${count}`;
}

function downloadNotes() {
  const notes = getNotes();
  if (notes.length === 0) { showToast('No notes yet'); return; }

  let md = '# CHI 2026 ‚Äî Reading Notes\n\n';
  md += `> Exported ${new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}\n\n`;

  // Group by type
  const types = ['idea', 'question', 'connection', 'action', 'note'];
  const byPaper = {};
  const general = [];
  notes.forEach(n => {
    if (n.paperId) {
      if (!byPaper[n.paperId]) byPaper[n.paperId] = [];
      byPaper[n.paperId].push(n);
    } else {
      general.push(n);
    }
  });

  const paperIds = Object.keys(byPaper).map(Number).sort((a,b) => a - b);
  paperIds.forEach(pid => {
    const paper = papers.find(p => p.id === pid);
    md += '---\n\n';
    md += `## P${String(pid).padStart(2,'0')}: ${paper ? paper.title : 'Unknown'}\n\n`;
    byPaper[pid].forEach(n => {
      const icon = noteTypeMap[n.type || 'note'][0];
      md += `- ${icon} **${n.date}:** ${n.text}\n`;
    });
    md += '\n';
  });

  if (general.length > 0) {
    md += '---\n\n## General Notes\n\n';
    general.forEach(n => {
      const icon = noteTypeMap[n.type || 'note'][0];
      md += `- ${icon} **${n.date}:** ${n.text}\n`;
    });
  }

  const blob = new Blob([md], { type: 'text/markdown' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'chi26-reading-notes.md';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Notes exported ‚Üì');
}

// ‚îÄ‚îÄ Voice Notes ‚îÄ‚îÄ
function toggleVoiceNote() {
  const btn = document.getElementById('voiceBtn');
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    showToast('Voice not supported in this browser');
    return;
  }

  if (isRecording) {
    recognition.stop();
    btn.classList.remove('recording');
    isRecording = false;
    showToast('Listening stopped');
    return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  const input = document.getElementById('notesInput');
  const startText = input.value;

  recognition.onresult = (event) => {
    let interim = '';
    let final = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const t = event.results[i][0].transcript;
      if (event.results[i].isFinal) final += t;
      else interim += t;
    }
    input.value = startText + (startText ? ' ' : '') + final + interim;
    input.style.height = 'auto';
    input.style.height = Math.min(input.scrollHeight, 100) + 'px';
  };

  recognition.onerror = () => {
    btn.classList.remove('recording');
    isRecording = false;
    showToast('Voice error ‚Äî try again');
  };

  recognition.onend = () => {
    btn.classList.remove('recording');
    isRecording = false;
  };

  recognition.start();
  btn.classList.add('recording');
  isRecording = true;
  showToast('Listening...');
}

// ‚îÄ‚îÄ @ Mention Autocomplete ‚îÄ‚îÄ
const notesInput = document.getElementById('notesInput');

notesInput.addEventListener('input', function(e) {
  this.style.height = 'auto';
  this.style.height = Math.min(this.scrollHeight, 100) + 'px';

  const val = this.value;
  const cursor = this.selectionStart;
  const before = val.substring(0, cursor);
  const atIdx = before.lastIndexOf('@P');

  if (atIdx >= 0 && (atIdx === 0 || before[atIdx - 1] === ' ')) {
    const query = before.substring(atIdx + 1).toLowerCase();
    const matches = papers.filter(p => {
      const pid = `p${String(p.id).padStart(2,'0')}`;
      return pid.startsWith(query.toLowerCase()) || p.title.toLowerCase().includes(query.replace(/^p\d*/, ''));
    }).slice(0, 6);

    if (matches.length > 0) {
      mentionActive = true;
      mentionStart = atIdx;
      mentionIndex = 0;
      renderMentionDropdown(matches);
      return;
    }
  }

  hideMentionDropdown();
});

notesInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey && !mentionActive) {
    e.preventDefault();
    addNote();
    return;
  }

  if (!mentionActive) return;

  const dropdown = document.getElementById('mentionDropdown');
  const items = dropdown.querySelectorAll('.mention-item');

  if (e.key === 'ArrowDown') {
    e.preventDefault();
    mentionIndex = Math.min(mentionIndex + 1, items.length - 1);
    updateMentionHighlight(items);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    mentionIndex = Math.max(mentionIndex - 1, 0);
    updateMentionHighlight(items);
  } else if (e.key === 'Enter' || e.key === 'Tab') {
    e.preventDefault();
    if (items[mentionIndex]) items[mentionIndex].click();
  } else if (e.key === 'Escape') {
    hideMentionDropdown();
  }
});

function renderMentionDropdown(matches) {
  const dd = document.getElementById('mentionDropdown');
  dd.innerHTML = matches.map((p, i) =>
    `<div class="mention-item ${i === 0 ? 'active' : ''}" onclick="insertMention(${p.id})">
      <span class="mention-item-id">P${String(p.id).padStart(2,'0')}</span>
      <span class="mention-item-title">${p.title}</span>
    </div>`
  ).join('');
  dd.classList.add('visible');
}

function updateMentionHighlight(items) {
  items.forEach((item, i) => item.classList.toggle('active', i === mentionIndex));
}

function insertMention(paperId) {
  const input = document.getElementById('notesInput');
  const val = input.value;
  const before = val.substring(0, mentionStart);
  const after = val.substring(input.selectionStart);
  const mention = `@P${String(paperId).padStart(2,'0')}`;
  input.value = before + mention + ' ' + after;
  input.focus();
  input.selectionStart = input.selectionEnd = (before + mention + ' ').length;
  hideMentionDropdown();
}

function hideMentionDropdown() {
  mentionActive = false;
  document.getElementById('mentionDropdown').classList.remove('visible');
}

// ‚îÄ‚îÄ Collapse/Expand ‚îÄ‚îÄ
function expandCard(el, paperId) {
  const card = el.closest('.paper');
  if (!card.classList.contains('collapsed')) return; // only act when collapsed
  card.classList.remove('collapsed');
}

function toggleCollapseAll() {
  allCollapsed = !allCollapsed;
  const icon = allCollapsed ? 'rows-4' : 'rows-3';
  document.getElementById('collapseToggle').innerHTML = `<i data-lucide="${icon}" style="margin-right:4px;font-size:13px;"></i> ${allCollapsed ? 'Expand all' : 'Collapse all'}`;
  localStorage.setItem(COLLAPSED_KEY, allCollapsed);
  renderPapers();
  if (window.lucide) lucide.createIcons();
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
function toggleRead(id) {
  const paper = papers.find(p => p.id === id);
  paper.read = !paper.read;
  saveState();
  updateStats();
  renderPapers();
  if (paper.read) recordActivity();
}

async function toggleAnalysis(id) {
  analysisOpen[id] = !analysisOpen[id];
  if (analysisOpen[id]) {
    setPaperContext(id);
    if (!analysisCache[id]) await loadAnalysis(id);
  } else {
    if (activePaperId === id) clearPaperContext();
  }
  renderPapers();
}

function renderPapers() {
  const list = document.getElementById('paperList');
  let filtered = papers;

  // Apply filter
  if (currentFilter === 'read') filtered = papers.filter(p => p.read);
  else if (currentFilter === 'unread') filtered = papers.filter(p => !p.read);
  else if (currentFilter !== 'all') filtered = papers.filter(p => p.tags.includes(currentFilter));

  // Apply search
  if (searchQuery) {
    filtered = filtered.filter(p =>
      p.title.toLowerCase().includes(searchQuery) ||
      p.relevance.toLowerCase().includes(searchQuery) ||
      (p.note && p.note.toLowerCase().includes(searchQuery))
    );
  }

  // Update results count
  document.getElementById('resultsCount').textContent = `${filtered.length} paper${filtered.length !== 1 ? 's' : ''}`;

  if (filtered.length === 0) {
    list.innerHTML = '<div class="empty-state">No papers match.</div>';
    return;
  }

  const tagMap = {
    interviews: ['tag-interviews', 'Interviews'],
    qual: ['tag-qual', 'Qual Analysis'],
    behavior: ['tag-behavior', 'Behavior'],
    agents: ['tag-agents', 'Agents'],
    bias: ['tag-bias', 'LLM Bias'],
    seena: ['tag-seena', 'Seena Labs'],
    brainspace: ['tag-brainspace', 'Brain Space'],
    eid: ['tag-eid', 'Everything is Designed'],
    valuesensitive: ['tag-valuesensitive', 'Value-Sensitive Design']
  };

  const ratings = getRatings();

  list.innerHTML = filtered.map((p, i) => {
    const tags = p.tags.map(t => {
      const [cls, label] = tagMap[t];
      return `<span class="paper-tag ${cls}">${label}</span>`;
    }).join('');

    const analysisBtn = p.hasAnalysis
      ? `<button class="action-btn btn-analysis ${analysisOpen[p.id] ? 'open' : ''}" onclick="toggleAnalysis(${p.id})">
           <i data-lucide="chevron-down" style="font-size:12px;margin-right:3px;"></i>${analysisOpen[p.id] ? 'Hide' : 'Analysis'}
         </button>`
      : '';

    const analysisContent = p.hasAnalysis && analysisOpen[p.id] ? (analysisCache[p.id] || '') : '';

    const noteCount = getNotes().filter(n => n.paperId === p.id).length;
    const noteBadge = noteCount > 0 ? `<span class="note-count-badge"><i data-lucide="message-square-text" style="font-size:11px;margin-right:3px;"></i>${noteCount}</span>` : '';

    const collapsed = allCollapsed && !analysisOpen[p.id] ? 'collapsed' : '';
    const ratingHtml = p.read ? renderRating(p.id) : '';

    return `
      <div class="paper ${p.read ? 'is-read' : ''} ${collapsed}" style="animation-delay: ${i * 0.03}s" data-id="${p.id}">
        <div class="paper-top" onclick="expandCard(this, ${p.id})">
          <span class="paper-number">${String(p.id).padStart(2, '0')}</span>
          <div class="paper-content">
            <div class="paper-title">${p.title}${p.essential ? '<span class="essential-badge">Essential</span>' : ''}</div>
          </div>
          ${collapsed ? '<i data-lucide="chevron-down" class="expand-chevron"></i>' : ''}
        </div>
        <div class="paper-body">
          <div class="paper-relevance">${p.relevance}</div>
          <div class="paper-tags">${tags}</div>
          ${p.note ? '<div class="paper-note">üìå ' + p.note + '</div>' : ''}
          <div class="paper-actions">
            <a href="${p.pdf}" target="_blank" rel="noopener" class="action-btn" onclick="setPaperContext(${p.id})"><i data-lucide="file-text" style="font-size:12px;margin-right:3px;"></i>PDF</a>
            ${p.arxiv ? `<a href="${p.arxiv}" target="_blank" rel="noopener" class="action-btn"><i data-lucide="external-link" style="font-size:11px;margin-right:3px;"></i>arXiv</a>` : ''}
            ${analysisBtn}
            ${noteBadge}
            <button class="action-btn btn-read ${p.read ? 'marked' : ''}" onclick="toggleRead(${p.id})">
              <i data-lucide="check-circle" style="font-size:12px;margin-right:3px;"></i>${p.read ? 'Read' : 'Mark read'}
            </button>
          </div>
          ${ratingHtml}
          ${analysisContent}
          ${renderPaperNotes(p.id)}
        </div>
      </div>`;
  }).join('');
  // Re-initialize Lucide icons for dynamically added elements
  if (window.lucide) lucide.createIcons();
}

// ‚îÄ‚îÄ TTS Engine ‚îÄ‚îÄ
let currentUtterance = null;
let allParagraphs = [];
let currentIndex = -1;
let isPlayingAll = false;

function ttsSpeak(el) {
  window.speechSynthesis.cancel();
  document.querySelectorAll('.tts-paragraph.speaking, .analysis-content p.speaking').forEach(p => p.classList.remove('speaking'));
  el.classList.add('speaking');
  el.scrollIntoView({ behavior: 'smooth', block: 'center' });
  const text = el.innerText;
  currentUtterance = new SpeechSynthesisUtterance(text);
  currentUtterance.rate = 1.0;
  currentUtterance.pitch = 1.0;
  const voices = window.speechSynthesis.getVoices();
  const preferred = voices.find(v => v.name.includes('Samantha') || v.name.includes('Daniel') || v.name.includes('Google'));
  if (preferred) currentUtterance.voice = preferred;
  currentUtterance.onend = () => {
    el.classList.remove('speaking');
    if (isPlayingAll) {
      currentIndex++;
      if (currentIndex < allParagraphs.length) ttsSpeak(allParagraphs[currentIndex]);
      else { isPlayingAll = false; updateTTSStatus('Done'); }
    }
  };
  updateTTSStatus('Speaking...');
  window.speechSynthesis.speak(currentUtterance);
}

function ttsPlayAll() {
  allParagraphs = Array.from(document.querySelectorAll('.tts-paragraph, .analysis-content p'));
  if (allParagraphs.length === 0) return;
  currentIndex = 0;
  isPlayingAll = true;
  ttsSpeak(allParagraphs[0]);
}

function ttsPause() {
  if (window.speechSynthesis.paused) { window.speechSynthesis.resume(); updateTTSStatus('Speaking...'); }
  else { window.speechSynthesis.pause(); updateTTSStatus('Paused'); }
}

function ttsStop() {
  isPlayingAll = false;
  currentIndex = -1;
  window.speechSynthesis.cancel();
  document.querySelectorAll('.tts-paragraph.speaking, .analysis-content p.speaking').forEach(p => p.classList.remove('speaking'));
  updateTTSStatus('Stopped');
}

function updateTTSStatus(text) { const el = document.getElementById('ttsStatus'); if (el) el.textContent = text; }

window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();

// ‚îÄ‚îÄ TTS click delegation for analysis-content paragraphs ‚îÄ‚îÄ
document.getElementById('paperList').addEventListener('click', function(e) {
  const p = e.target.closest('.analysis-content p');
  if (p) ttsSpeak(p);
});

// ‚îÄ‚îÄ Filter Buttons ‚îÄ‚îÄ
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    renderPapers();
  });
});

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
function showToast(msg) {
  const toast = document.getElementById('notesToast');
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

// ‚îÄ‚îÄ GitHub Sync ‚îÄ‚îÄ
const GH_TOKEN_KEY = 'chi26-gh-token';
const GH_REPO_KEY = 'chi26-gh-repo';
const GH_PATH_KEY = 'chi26-gh-path';

function getGHConfig() {
  return {
    token: localStorage.getItem(GH_TOKEN_KEY) || '',
    repo: localStorage.getItem(GH_REPO_KEY) || 'thaxali/HCI',
    path: localStorage.getItem(GH_PATH_KEY) || 'CHI26/notes'
  };
}

function isGHConfigured() {
  const cfg = getGHConfig();
  return cfg.token && cfg.repo && cfg.path;
}

function updateGHIcon() {
  const icon = document.getElementById('ghSyncStatus');
  const syncBtn = document.getElementById('syncBtn');
  if (isGHConfigured()) {
    icon.innerHTML = '<i data-lucide="github"></i>';
    icon.classList.add('gh-connected');
    icon.title = 'GitHub sync connected';
    if (syncBtn) syncBtn.style.display = '';
  } else {
    icon.innerHTML = '<i data-lucide="github"></i>';
    icon.classList.remove('gh-connected');
    icon.title = 'GitHub sync ‚Äî not connected';
    if (syncBtn) syncBtn.style.display = 'none';
  }
}

async function quickSync() {
  const btn = document.getElementById('syncBtn');
  if (btn.classList.contains('syncing')) return;

  btn.classList.remove('synced', 'sync-error');
  btn.classList.add('syncing');
  btn.title = 'Syncing...';
  if (window.lucide) lucide.createIcons();

  try {
    await pullNotesFromGitHub();
    await syncNotesToGitHub();
    btn.classList.remove('syncing');
    btn.classList.add('synced');
    btn.title = 'Synced!';
    showToast('Synced with GitHub');
    setTimeout(() => { btn.classList.remove('synced'); btn.title = 'Sync with GitHub'; }, 3000);
  } catch (e) {
    btn.classList.remove('syncing');
    btn.classList.add('sync-error');
    btn.title = 'Sync failed';
    showToast('Sync failed ‚Äî check settings');
    setTimeout(() => { btn.classList.remove('sync-error'); btn.title = 'Sync with GitHub'; }, 3000);
  }
  if (window.lucide) lucide.createIcons();
}

// ‚îÄ‚îÄ Queue Modal ‚îÄ‚îÄ

function openQueueModal() {
  document.getElementById('queueUrlInput').value = '';
  document.getElementById('queueStatus').textContent = '';
  document.getElementById('queueSubmitBtn').disabled = false;
  document.getElementById('queueOverlay').classList.add('open');
  setTimeout(() => document.getElementById('queueUrlInput').focus(), 100);
}

function closeQueueModal() {
  document.getElementById('queueOverlay').classList.remove('open');
}

async function submitToQueue() {
  const input = document.getElementById('queueUrlInput');
  const status = document.getElementById('queueStatus');
  const btn = document.getElementById('queueSubmitBtn');
  const url = input.value.trim();

  if (!url) { status.textContent = 'Please enter a URL.'; return; }
  if (!/^https?:\/\/.+/.test(url)) { status.textContent = 'Enter a valid URL starting with http(s)://'; return; }

  const cfg = getGHConfig();
  if (!cfg.token) {
    status.innerHTML = 'GitHub token not configured. <a href="#" onclick="closeQueueModal();openSettings();return false;" style="color:var(--accent)">Set it up</a> first.';
    return;
  }

  btn.disabled = true;
  status.textContent = 'Adding to queue...';

  try {
    const filePath = 'queue.md';
    // Get current file content and SHA
    const getRes = await fetch(`https://api.github.com/repos/${cfg.repo}/contents/${filePath}`, {
      headers: { 'Authorization': `Bearer ${cfg.token}`, 'Accept': 'application/vnd.github+json' }
    });

    let currentContent = '# Reading Queue\n\n## Pending\n\n## Processed\n';
    let sha = null;

    if (getRes.ok) {
      const existing = await getRes.json();
      sha = existing.sha;
      currentContent = decodeURIComponent(escape(atob(existing.content.replace(/\n/g, ''))));
    }

    // Insert URL under ## Pending
    const pendingIdx = currentContent.indexOf('## Pending');
    if (pendingIdx === -1) {
      status.textContent = 'Could not find ## Pending section in queue.md';
      btn.disabled = false;
      return;
    }
    const insertPos = pendingIdx + '## Pending'.length;
    const before = currentContent.slice(0, insertPos);
    const after = currentContent.slice(insertPos);
    const newContent = before + '\n- ' + url + after;

    const body = {
      message: `Queue: ${url}`,
      content: btoa(unescape(encodeURIComponent(newContent))),
      branch: 'main'
    };
    if (sha) body.sha = sha;

    const putRes = await fetch(`https://api.github.com/repos/${cfg.repo}/contents/${filePath}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${cfg.token}`,
        'Accept': 'application/vnd.github+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });

    if (!putRes.ok) {
      const err = await putRes.json();
      status.textContent = 'Failed: ' + (err.message || 'Unknown error');
      btn.disabled = false;
      return;
    }

    status.style.color = 'var(--accent)';
    status.textContent = 'Queued! Claude will process it shortly.';
    showToast('URL added to queue');
    setTimeout(() => { closeQueueModal(); status.style.color = ''; }, 2000);
  } catch (e) {
    status.textContent = 'Network error: ' + e.message;
    btn.disabled = false;
  }
}

function openSettings() {
  const cfg = getGHConfig();
  document.getElementById('ghTokenInput').value = cfg.token;
  document.getElementById('ghRepoInput').value = cfg.repo;
  document.getElementById('ghPathInput').value = cfg.path;
  document.getElementById('ghSettingsStatus').textContent = '';
  document.getElementById('ghSyncSection').style.display = isGHConfigured() ? 'block' : 'none';
  document.getElementById('settingsOverlay').classList.add('open');
}

function closeSettings() {
  document.getElementById('settingsOverlay').classList.remove('open');
}

function saveGitHubSettings() {
  const token = document.getElementById('ghTokenInput').value.trim();
  const repo = document.getElementById('ghRepoInput').value.trim();
  const path = document.getElementById('ghPathInput').value.trim();
  if (!token || !repo || !path) {
    document.getElementById('ghSettingsStatus').textContent = 'All fields required.';
    return;
  }
  localStorage.setItem(GH_TOKEN_KEY, token);
  localStorage.setItem(GH_REPO_KEY, repo);
  localStorage.setItem(GH_PATH_KEY, path);
  document.getElementById('ghSettingsStatus').textContent = '‚úì Saved';
  document.getElementById('ghSyncSection').style.display = 'block';
  updateGHIcon();
  showToast('GitHub sync configured');
}

async function testGitHubConnection() {
  const token = document.getElementById('ghTokenInput').value.trim();
  const repo = document.getElementById('ghRepoInput').value.trim();
  const status = document.getElementById('ghSettingsStatus');
  if (!token || !repo) { status.textContent = 'Enter token and repo first.'; return; }
  status.textContent = 'Testing...';
  try {
    const res = await fetch(`https://api.github.com/repos/${repo}`, {
      headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/vnd.github+json' }
    });
    if (res.ok) {
      const data = await res.json();
      status.textContent = `‚úì Connected to ${data.full_name} (${data.visibility})`;
      status.style.color = 'var(--green)';
    } else {
      const err = await res.json();
      status.textContent = `‚úó ${res.status}: ${err.message || 'Failed'}`;
      status.style.color = 'var(--rose)';
    }
  } catch (e) {
    status.textContent = `‚úó Network error: ${e.message}`;
    status.style.color = 'var(--rose)';
  }
}

// Build markdown content for a paper's notes
function buildPaperNotesMarkdown(paperId) {
  const paper = papers.find(p => p.id === paperId);
  if (!paper) return null;
  const notes = getNotes().filter(n => n.paperId === paperId);
  const ratings = getRatings();
  const rating = ratings[paperId];

  let md = `# P${String(paperId).padStart(2,'0')}: ${paper.title}\n\n`;
  md += `> **Status:** ${paper.read ? 'Read ‚úì' : 'Unread'}\n`;
  if (rating) md += `> **Rating:** ${'‚òÖ'.repeat(rating)}${'‚òÜ'.repeat(5-rating)} (${rating}/5)\n`;
  md += `> **Tags:** ${paper.tags.join(', ')}\n`;
  md += `> **PDF:** ${paper.pdf}\n`;
  md += `> **arXiv:** ${paper.arxiv}\n\n`;

  if (paper.relevance) {
    md += `## Relevance\n\n${paper.relevance.replace(/<\/?em>/g, '*')}\n\n`;
  }

  if (notes.length > 0) {
    md += `## Notes\n\n`;
    const types = ['idea', 'question', 'connection', 'action', 'note'];
    const typeLabels = { idea: 'Ideas', question: 'Questions', connection: 'Connections', action: 'Action Items', note: 'Notes' };

    types.forEach(type => {
      const typed = notes.filter(n => (n.type || 'note') === type);
      if (typed.length === 0) return;
      const icon = noteTypeMap[type][0];
      md += `### ${icon} ${typeLabels[type]}\n\n`;
      typed.forEach(n => {
        md += `- ${n.text} *(${n.date})*\n`;
      });
      md += '\n';
    });
  }

  return md;
}

// Write a single paper's notes to GitHub
async function pushPaperNotes(paperId) {
  const cfg = getGHConfig();
  if (!cfg.token) return;

  const md = buildPaperNotesMarkdown(paperId);
  if (!md) return;

  const filename = `paper-${String(paperId).padStart(2,'0')}.md`;
  const filePath = `${cfg.path}/${filename}`;
  const content = btoa(unescape(encodeURIComponent(md)));

  try {
    // Check if file already exists (to get sha for update)
    let sha = null;
    const getRes = await fetch(`https://api.github.com/repos/${cfg.repo}/contents/${filePath}`, {
      headers: { 'Authorization': `Bearer ${cfg.token}`, 'Accept': 'application/vnd.github+json' }
    });
    if (getRes.ok) {
      const existing = await getRes.json();
      sha = existing.sha;
    }

    const body = {
      message: `Update notes for P${String(paperId).padStart(2,'0')}`,
      content: content,
      branch: 'main'
    };
    if (sha) body.sha = sha;

    const putRes = await fetch(`https://api.github.com/repos/${cfg.repo}/contents/${filePath}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${cfg.token}`,
        'Accept': 'application/vnd.github+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });

    if (!putRes.ok) {
      const err = await putRes.json();
      console.error('GitHub push failed:', err);
      return false;
    }
    return true;
  } catch (e) {
    console.error('GitHub push error:', e);
    return false;
  }
}

// Push all notes to GitHub
async function syncNotesToGitHub() {
  const cfg = getGHConfig();
  if (!cfg.token) { showToast('Configure GitHub first'); return; }

  const status = document.getElementById('ghSyncStatus2');
  status.textContent = 'Syncing...';

  // Find all papers that have notes, ratings, or are read
  const allNotes = getNotes();
  const ratings = getRatings();
  const paperIds = new Set();

  allNotes.forEach(n => { if (n.paperId) paperIds.add(n.paperId); });
  Object.keys(ratings).forEach(id => paperIds.add(Number(id)));
  papers.filter(p => p.read).forEach(p => paperIds.add(p.id));

  let success = 0;
  let failed = 0;
  for (const pid of paperIds) {
    const ok = await pushPaperNotes(pid);
    if (ok) success++; else failed++;
  }

  // Also push a summary/index file
  await pushSummaryFile();

  status.textContent = `‚úì Pushed ${success} paper${success !== 1 ? 's' : ''}${failed > 0 ? `, ${failed} failed` : ''}`;
  status.style.color = failed > 0 ? 'var(--amber)' : 'var(--green)';
  showToast(`Synced ${success} files to GitHub`);
}

// Push a summary index file
async function pushSummaryFile() {
  const cfg = getGHConfig();
  if (!cfg.token) return;

  const allNotes = getNotes();
  const ratings = getRatings();
  const readCount = papers.filter(p => p.read).length;

  let md = `# CHI 2026 ‚Äî Reading Notes\n\n`;
  md += `> Auto-generated summary. Last synced: ${new Date().toLocaleString()}\n\n`;
  md += `**Progress:** ${readCount}/${papers.length} papers read\n\n`;
  md += `## Papers\n\n`;
  md += `| # | Title | Status | Rating | Notes |\n`;
  md += `|---|-------|--------|--------|-------|\n`;

  papers.forEach(p => {
    const noteCount = allNotes.filter(n => n.paperId === p.id).length;
    const rating = ratings[p.id];
    const stars = rating ? '‚òÖ'.repeat(rating) + '‚òÜ'.repeat(5 - rating) : '‚Äî';
    const status = p.read ? '‚úì Read' : '‚Äî';
    const link = noteCount > 0 ? `[${noteCount} note${noteCount !== 1 ? 's' : ''}](paper-${String(p.id).padStart(2,'0')}.md)` : '‚Äî';
    md += `| P${String(p.id).padStart(2,'0')} | ${p.title.substring(0, 60)}${p.title.length > 60 ? '...' : ''} | ${status} | ${stars} | ${link} |\n`;
  });

  md += `\n---\n\n*This file is read/written by the CHI'26 Reading List UI and can be accessed by Claude via its GitHub connection.*\n`;

  const content = btoa(unescape(encodeURIComponent(md)));
  const filePath = `${cfg.path}/README.md`;

  try {
    let sha = null;
    const getRes = await fetch(`https://api.github.com/repos/${cfg.repo}/contents/${filePath}`, {
      headers: { 'Authorization': `Bearer ${cfg.token}`, 'Accept': 'application/vnd.github+json' }
    });
    if (getRes.ok) {
      const existing = await getRes.json();
      sha = existing.sha;
    }

    const body = { message: 'Update reading notes summary', content, branch: 'main' };
    if (sha) body.sha = sha;

    await fetch(`https://api.github.com/repos/${cfg.repo}/contents/${filePath}`, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${cfg.token}`,
        'Accept': 'application/vnd.github+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
  } catch (e) {
    console.error('GitHub summary push error:', e);
  }
}

// Pull notes from GitHub
async function pullNotesFromGitHub() {
  const cfg = getGHConfig();
  if (!cfg.token) { showToast('Configure GitHub first'); return; }

  const status = document.getElementById('ghSyncStatus2');
  status.textContent = 'Pulling...';

  try {
    // List all files in the notes folder
    const listRes = await fetch(`https://api.github.com/repos/${cfg.repo}/contents/${cfg.path}`, {
      headers: { 'Authorization': `Bearer ${cfg.token}`, 'Accept': 'application/vnd.github+json' }
    });

    if (!listRes.ok) {
      status.textContent = `‚úó Could not list notes folder`;
      status.style.color = 'var(--rose)';
      return;
    }

    const files = await listRes.json();
    const noteFiles = files.filter(f => f.name.startsWith('paper-') && f.name.endsWith('.md'));

    let imported = 0;
    const existingNotes = getNotes();

    for (const file of noteFiles) {
      const fileRes = await fetch(file.download_url);
      const md = await fileRes.text();

      // Extract paper ID from filename
      const match = file.name.match(/paper-(\d+)\.md/);
      if (!match) continue;
      const paperId = parseInt(match[1], 10);

      // Parse notes from the markdown
      const noteLines = md.match(/^- (.+?) \*\((.+?)\)\*$/gm);
      if (!noteLines) continue;

      noteLines.forEach(line => {
        const lineMatch = line.match(/^- (.+?) \*\((.+?)\)\*$/);
        if (!lineMatch) return;
        const text = lineMatch[1];
        const date = lineMatch[2];

        // Check if this note already exists locally
        const exists = existingNotes.some(n => n.paperId === paperId && n.text === text);
        if (!exists) {
          // Detect note type from which section it's under (simplified ‚Äî default to 'note')
          const paper = papers.find(p => p.id === paperId);
          existingNotes.push({
            text,
            type: 'note',
            paperId,
            paperTitle: paper ? paper.title : null,
            timestamp: new Date().toISOString(),
            date
          });
          imported++;
        }
      });

      // Also check for read status
      if (md.includes('Status:** Read')) {
        const paper = papers.find(p => p.id === paperId);
        if (paper && !paper.read) {
          paper.read = true;
        }
      }

      // Check for rating
      const ratingMatch = md.match(/Rating:\*\* [‚òÖ‚òÜ]+ \((\d)\/5\)/);
      if (ratingMatch) {
        const ratings = getRatings();
        ratings[paperId] = parseInt(ratingMatch[1], 10);
        localStorage.setItem(RATINGS_KEY, JSON.stringify(ratings));
      }
    }

    if (imported > 0) {
      saveNotes(existingNotes);
      saveState();
      updateStats();
      renderPapers();
    }

    status.textContent = `‚úì Pulled ${noteFiles.length} file${noteFiles.length !== 1 ? 's' : ''}, imported ${imported} new note${imported !== 1 ? 's' : ''}`;
    status.style.color = 'var(--green)';
    showToast(`Imported ${imported} new notes`);
  } catch (e) {
    status.textContent = `‚úó Error: ${e.message}`;
    status.style.color = 'var(--rose)';
  }
}

// Auto-push when adding a note (if configured)
const _originalAddNote = addNote;
addNote = function() {
  const input = document.getElementById('notesInput');
  const text = input.value.trim();
  if (!text) return;

  const notes = getNotes();
  const paper = activePaperId ? papers.find(p => p.id === activePaperId) : null;
  notes.push({
    text,
    type: currentNoteType,
    paperId: activePaperId || null,
    paperTitle: paper ? paper.title : null,
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' })
  });
  saveNotes(notes);
  input.value = '';
  input.style.height = 'auto';
  const label = paper ? `${noteTypeMap[currentNoteType][1]} saved to P${String(activePaperId).padStart(2,'0')} ‚úì` : `${noteTypeMap[currentNoteType][1]} saved ‚úì`;
  showToast(label);
  renderPapers();
  recordActivity();

  // Auto-push to GitHub if configured and note is tagged to a paper
  if (activePaperId && isGHConfigured()) {
    pushPaperNotes(activePaperId).then(ok => {
      if (ok) showToast('Synced to GitHub ‚úì');
    });
  }
};

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
loadTheme();
allCollapsed = localStorage.getItem(COLLAPSED_KEY) === 'true';
if (allCollapsed) document.getElementById('collapseToggle').innerHTML = '<i data-lucide="rows-" style="margin-right:4px;font-size:13px;"></i> Expand all';
updateGHIcon();
if (window.lucide) lucide.createIcons();

// Load papers from JSON, then initialize everything
loadPapers().then(() => {
  loadReadState();
  updateStats();
  renderStreak();
  renderPapers();
  updateNotesCount();
  if (window.lucide) lucide.createIcons();
});
</script>
</body>
</html>
